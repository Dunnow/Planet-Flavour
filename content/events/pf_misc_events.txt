namespace = pf_misc

# Hive Stars spawn system
system_event = {
	id = pf_misc.100
	is_triggered_only = yes
	hide_window = yes

	immediate = {
		create_species = {
			name = "NAME_Prethoryn"
			class = SWARM
			namelist = Prethoryn
			portrait = random
			traits = random
			immortal = yes

			effect = { save_event_target_as = pf_straggler_prethoryn_species }
		}

		create_country = {
			name = "NAME_pf_straggler_swarms"
			type = pf_straggler_swarm

			flag = {
				icon= {
					category = "special"
					file = "the_swarm.dds"
				}
				background= {
					category = "backgrounds"
					file = "new_dawn.dds"
				}
				colors={
					"grey"
					"orange"
					"null"
					"null"
				}
			}
			effect = {
				set_graphical_culture = swarm_01
				set_country_flag = pf_straggler_swarms
				save_global_event_target_as = pf_straggler_swarms_country
			}
		}

		spawn_system = {
			min_distance >= 90
			max_distance <= 100
			direction = rimwards
			initializer = pf_hive_stars_core_initializer
			hyperlane = no
		}
	}
}

event = {
	id = pf_misc.110
	is_triggered_only = yes
	hide_window = yes

	immediate = {
		random_list = {
			3 = { } # nothing
			1 = {
				random_rim_system = {
					system_event = { id = pf_misc.100 }
				}
			}
		}
	}
}

# Hive Stars spawn system
system_event = {
	id = pf_misc.200
	is_triggered_only = yes
	hide_window = yes

	immediate = {
		# We're on a random system. We need to find the furthest from us.

		spawn_system = {
			min_distance >= 10
			max_distance <= 20
			direction = rimwards
			initializer = pf_ringworld_network_01
			hyperlane = yes
		}

		last_created_system = {
			save_event_target_as = pf_first_system
			save_event_target_as = pf_distance_check_source
			set_variable = {
				which = pf_best_distance
				value = 0
			}
			every_system = {
				limit = { not = { has_star_flag = crisis_spawn_exclude } } #is_rim_system = yes
				save_event_target_as = pf_distance_check_target
				set_variable = {
					which = pf_candidate_distance
					value = value:pf_star_distance_euclidean
				}
				log = "Comparing for [This.GetName], Distance [This.pf_candidate_distance], Best [pf_distance_check_source.pf_best_distance]"
				if = {
					limit = {
						# Check if it's farther than our current best
						event_target:pf_distance_check_source = {
							check_variable = {
								which = pf_best_distance
								value < prev.pf_candidate_distance
							}
						}
					}
					log = "Found new best candidate [This.GetName]. Old candidate [pf_best_candidate.GetName]"
					save_event_target_as = pf_best_candidate
					event_target:pf_distance_check_source = {
						set_variable = {
							which = pf_best_distance
							value = prev.pf_candidate_distance
						}
					}
				}
			}
			event_target:pf_best_candidate = {
				set_star_flag = pf_best_candidate
				spawn_system = {
					min_distance >= 10
					max_distance <= 20
					direction = rimwards
					initializer = pf_ringworld_network_01
					hyperlane = no
				}
			}
			last_created_system = {
				save_event_target_as = pf_second_system
			}
		}
	}
}